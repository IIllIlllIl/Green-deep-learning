# 全局标准化 vs 组内标准化对比报告

**生成日期**: 2026-01-30
**报告版本**: v1.0
**分析脚本**: `scripts/compare_standardization_methods.py`

## 摘要

本报告对比了两种数据标准化策略：
- **全局标准化** (`data/energy_research/6groups_global_std/`) - 所有6组使用相同的均值和标准差
- **组内标准化** (`data/energy_research/6groups_interaction/`) - 每组使用自己的均值和标准差

### 关键发现
1. **尺度统一性恢复成功**：全局标准化使得ATE可以跨组直接比较
2. **结构性NaN正确保留**：两种策略都保留了组特有的超参数/性能指标的NaN
3. **数据完整性一致**：样本数完全匹配（818个总样本）
4. **hyperparam_seed特殊处理**：全局标准化用-1填充缺失值，便于分析seed效应

## 详细对比分析

### 1. 核心差异总结

| 方面 | 全局标准化 | 组内标准化 | 对ATE分析的影响 |
|------|-----------|------------|----------------|
| **尺度** | 所有组相同的均值/标准差 | 每组独立的均值/标准差 | ⭐ **关键差异** |
| **跨组可比性** | ✅ 完全可比 | ❌ 不可直接比较 | 全局：ATE跨组可比；组内：仅组内可比 |
| **结构性NaN** | ✅ 保留（组特有的超参数/性能指标） | ✅ 保留 | 两种方法都正确处理 |
| **hyperparam_seed** | 用-1填充缺失值（表示"未设置seed"） | 保持原始NaN | 全局：便于分析seed效应 |
| **交互项** | 重新计算，继承NaN状态 | 原始交互项 | 全局：更规范的交互项 |
| **样本数** | 818总样本（6组） | 818总样本（6组） | 完全一致 |
| **能耗数据** | 0个NaN（完全完整） | 0个NaN（完全完整） | 数据质量优秀 |

### 2. energy_gpu_avg_watts 标准化参数对比

**全局标准化参数（所有组使用）**:
- 均值：186.05 watts
- 标准差：68.34 watts

**组内标准化参数**:
| 组 | 均值 (watts) | 标准差 (watts) | 标准差差异 vs 全局 |
|---|-------------|----------------|-------------------|
| group1_examples | 162.62 | 72.97 | +6.8% |
| group2_vulberta | 223.99 | 8.10 | -88.1% |
| group3_person_reid | 226.90 | 14.60 | -78.6% |
| group4_bug_localization | 72.33 | 27.83 | -59.3% |
| group5_mrt_oast | 235.75 | 10.09 | -85.2% |
| group6_resnet | 221.66 | 17.16 | -74.9% |

**分析**：
- 组间标准差差异巨大（8.10-72.97 watts）
- 全局标准差68.34 watts是所有组的"平均"尺度
- **ATE解释差异**：
  - 组内ATE：表示"变化X watts"的效应，但X在各组中不同
  - 全局ATE：表示"变化68.34 watts"的效应，在所有组中相同

### 3. 样本分布验证

| 组 | 样本数 | 全局标准化列数 | 组内标准化列数 | 状态 |
|---|--------|---------------|---------------|------|
| group1_examples | 304 | 50 | 24 | ✓ 一致 |
| group2_vulberta | 72 | 50 | 23 | ✓ 一致 |
| group3_person_reid | 206 | 50 | 25 | ✓ 一致 |
| group4_bug_localization | 90 | 50 | 24 | ✓ 一致 |
| group5_mrt_oast | 72 | 50 | 25 | ✓ 一致 |
| group6_resnet | 74 | 50 | 22 | ✓ 一致 |

**说明**：
- 样本数完全一致
- 列数差异：全局标准化包含所有可能的列（50列），组内标准化只包含该组存在的列（22-25列）
- 这是预期行为：全局标准化保留所有列（包括其他组的列，值为NaN）

### 4. 跨组可比性验证

**比较group1（低能耗）vs group2（高能耗）**：

| 方法 | group1均值（标准化） | group2均值（标准化） | 差异 | 可比性 | 说明 |
|------|---------------------|---------------------|------|--------|------|
| 全局标准化 | -0.3428 | 0.5551 | 0.898 | ✅ 可比 | 使用相同尺度，差异反映真实能耗差异 |
| 组内标准化 | 1.67e-16 | 2.29e-15 | 2.13e-15 | ❌ 不可比 | 每组均值为0，差异被标准化消除 |

**关键洞察**：
- 组内标准化消除了组间均值差异（每组均值为0）
- 这使得无法直接比较不同组的ATE
- 全局标准化保留了组间差异，允许跨组比较

### 5. 超参数覆盖分析

**适合跨组比较的超参数**（存在于至少2个组中）：

| 超参数 | 有效值数 | 覆盖率 | 存在组数 | 研究价值 |
|--------|---------|--------|----------|----------|
| **hyperparam_learning_rate** | 542 | 66.3% | 5组 | ⭐⭐⭐ 核心超参数 |
| **hyperparam_epochs** | 546 | 66.7% | 5组 | ⭐⭐⭐ 核心超参数 |
| **hyperparam_l2_regularization** | 130 | 15.9% | 3组 | ⭐⭐ 有价值 |
| **hyperparam_dropout** | 224 | 27.4% | 2组 | ⭐⭐ 有价值 |
| **hyperparam_seed** | 818 | 100% | 6组 | ⭐ 控制变量 |

**仅单组独有**（不适合跨组比较）：
- hyperparam_batch_size（仅group1）
- hyperparam_alpha（仅group4）
- hyperparam_kfold（仅group4）
- hyperparam_max_iter（仅group4）

### 6. 新的全局标准化数据生成流程

全局标准化数据通过 `scripts/create_global_standardized_data.py` 生成，流程如下：

#### 步骤1：合并与预处理
- 合并所有6组数据（保留所有列）
- 用-1填充 `hyperparam_seed` 缺失值（表示"未设置seed"）

#### 步骤2：全局标准化
1. **计算全局统计量**：基于所有非NaN值计算每列的均值和标准差
2. **保留结构性NaN**：组特有的超参数/性能指标保持为NaN
3. **标准化非NaN值**：`z = (x - global_mean) / global_std`

#### 步骤3：交互项重建
- 计算所有超参数 × is_parallel 交互项
- 交互项继承NaN状态（某组没有的超参数，其交互项为NaN）

#### 步骤4：输出
- 每组一个CSV文件（`[group]_global_std.csv`）
- 全局标准化参数文件（`global_standardization_params.json`）
- 生成报告（`generation_report.json`）

### 7. 与之前数据的区别总结

| 方面 | 之前的数据（组内标准化） | 新的数据（全局标准化） | 改进 |
|------|------------------------|----------------------|------|
| **标准化尺度** | 每组独立的尺度 | 所有组统一的尺度 | ✅ 恢复跨组可比性 |
| **ATE解释** | "变化X单位"的效应，X在各组不同 | "变化Y单位"的效应，Y在所有组相同 | ✅ 统一解释 |
| **hyperparam_seed** | 保持原始NaN | 用-1填充缺失值 | ✅ 便于分析seed效应 |
| **交互项** | 原始交互项 | 重新计算，继承NaN状态 | ✅ 更规范 |
| **列结构** | 每组只包含自己有的列 | 所有组包含所有列（值为NaN） | ✅ 统一结构 |
| **跨组分析** | 不可直接比较 | 可以直接比较 | ⭐ **关键改进** |

### 8. 使用建议

#### 使用全局标准化的场景（推荐用于新分析）：
- **跨组ATE比较**：研究超参数对能耗的普遍影响
- **整体模式发现**：发现跨模型的共同规律
- **方法验证**：对比不同模型的敏感性
- **seed效应分析**：研究有seed和无seed实验的能耗差异
- **交互效应研究**：分析is_parallel的调节作用

#### 使用组内标准化的场景（历史延续）：
- **单组深入分析**：深入研究特定模型的超参数影响
- **模型特性研究**：分析特定模型的独特行为
- **历史分析延续**：与之前的分析保持一致

### 9. 下一步行动建议

1. **重新计算ATE**：使用全局标准化数据重新计算所有超参数的ATE
2. **跨组比较分析**：
   - 分析learning_rate和epochs等共同超参数的跨组效应
   - 计算跨组平均ATE及其置信区间
3. **seed效应分析**：
   - 比较有seed（正整数值）和无seed（-1）实验的能耗波动性
   - 分析seed对能耗鲁棒性的影响
4. **敏感性分析**：
   - 对比全局标准化和组内标准化的ATE结果差异
   - 验证关键发现对标准化方法的鲁棒性
5. **交互效应研究**：
   - 分析is_parallel如何调节超参数对能耗的影响
   - 比较并行vs非并行模式下的超参数效应

### 10. 技术验证结果

#### 尺度一致性验证：
- ✅ 所有组使用相同的全局均值（186.05）和标准差（68.34）
- ✅ 标准化值范围符合预期（大部分在-2到2之间）
- ✅ 每组均值接近0，标准差接近1（由于NaN存在，略有偏差）

#### 数据质量验证：
- ✅ 能耗数据：0个NaN（100%完整性）
- ✅ 样本数：完全一致（818总样本）
- ✅ 结构性NaN：正确保留（组特有的超参数/性能指标）

#### 跨组可比性验证：
- ✅ 全局标准化：组间差异可解释（如group2比group1高0.898个标准差单位）
- ❌ 组内标准化：组间差异被消除（每组均值为0）

## 结论

**全局标准化成功恢复了跨组可比性**，为跨模型超参数效应分析提供了统一的尺度。新的数据集允许：

1. **直接比较不同模型的ATE**：例如，比较learning_rate对能耗的效应在6个模型之间是否一致
2. **计算跨组平均效应**：提供更稳健的整体结论
3. **分析seed的调节作用**：利用-1标记研究有seed和无seed实验的差异
4. **统一的因果图学习**：所有组使用相同的尺度，DiBS可以学习跨组一致的因果结构

**推荐所有新的因果分析使用全局标准化数据**，除非有特定原因需要分析单个模型的独特行为。

---

**报告生成**：通过分析 `scripts/compare_standardization_methods.py` 的输出
**数据位置**：`data/energy_research/6groups_global_std/`
**相关文档**：`docs/energy_research/standardization_strategy.md`（待创建）

> **维护建议**：所有后续的ATE计算和因果分析应基于全局标准化数据，以确保结果的可比性和可解释性。