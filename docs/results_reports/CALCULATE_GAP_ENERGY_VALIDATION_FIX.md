# calculate_experiment_gap.py 能耗数据验证修复报告

**修复日期**: 2025-12-15
**版本**: v4.7.7
**严重程度**: 中等 ⭐⭐
**影响范围**: 实验缺口计算准确性

---

## 问题发现

### 触发原因
用户要求检查 `scripts/calculate_experiment_gap.py` 是否遗漏了raw_data.csv中的其他信息。

### 问题定位
**位置**: `scripts/calculate_experiment_gap.py` 第129行（修复后第133行）

**问题代码**:
```python
# 只统计训练成功且有性能数据的实验
if not training_success or not has_perf:
    continue
```

**根因**: 验证逻辑**缺少能耗数据完整性检查**

---

## 影响分析

### 1. 研究目标要求
根据 `CLAUDE.md` 第78行明确定义：

> **每个超参数在两种模式（并行/非并行）下都需要**:
> 1. 1个默认值实验 - 建立基线
> 2. 5个唯一单参数变异实验 - 研究单参数影响
> 3. **完整数据**: **能耗 + 任意性能指标** ⭐

### 2. 数据完整性现状

| 验证标准 | 有效实验数 | 占总数584 |
|---------|----------|----------|
| 训练成功 | 502 | 86.0% |
| 训练成功 + 性能数据 | ~430 | ~74% |
| 训练成功 + 性能数据 + **能耗数据** | **371** | **63.5%** ✅ |

**关键发现**:
- 约**59个实验**（10%）有性能数据但**缺少能耗数据**
- 这些实验在修复前被错误地计入"有效实验"

### 3. 对实验缺口计算的影响
- **修复前**: 高估有效实验数（~430），低估实验缺口
- **修复后**: 准确统计有效实验数（371），准确计算实验缺口（90个）

---

## 修复实现

### 代码变更

#### 非并行模式能耗检查（新增）
```python
# Line 126-127
has_energy = (row.get('energy_cpu_total_joules', '') and
             row.get('energy_gpu_total_joules', ''))
```

**检查字段**:
- `energy_cpu_total_joules` - CPU总能耗（焦耳）
- `energy_gpu_total_joules` - GPU总能耗（焦耳）

#### 并行模式能耗检查（新增）
```python
# Line 118-119
has_energy = (row.get('fg_energy_cpu_total_joules', '') and
             row.get('fg_energy_gpu_total_joules', ''))
```

**检查字段**:
- `fg_energy_cpu_total_joules` - 前景训练CPU总能耗
- `fg_energy_gpu_total_joules` - 前景训练GPU总能耗

#### 验证逻辑更新
```python
# Line 132-134 (修复后)
# 只统计训练成功且有性能数据和能耗数据的实验
if not training_success or not has_perf or not has_energy:
    continue
```

---

## 验证结果

### 修复前后对比

#### 修复前（仅检查训练+性能）
- 有效实验数: ~430
- 验证标准: 训练成功 + 性能数据
- **问题**: 忽略能耗数据缺失

#### 修复后（检查训练+性能+能耗）✅
- 有效实验数: **371**
- 验证标准: 训练成功 + 性能数据 + **能耗数据**
- **符合**: CLAUDE.md研究目标定义

### 实验缺口统计（修复后）

| 模型 | 非并行缺口 | 并行缺口 | 总缺口 | 预计时间 |
|------|----------|---------|--------|---------|
| VulBERTa/mlp | 20 | 20 | **40** | 41.72h |
| bug-localization | 20 | 20 | **40** | 10.90h |
| MRT-OAST | 0 | 10 | **10** | 4.36h |
| **总计** | **40** | **50** | **90** | **56.98h** |

### 达标情况（修复后）

| 指标 | 值 |
|------|---|
| 达标参数-模式组合 | 17/90 (18.9%) |
| 非并行模式达标模型 | 9/11 (81.8%) |
| 并行模式达标模型 | 8/11 (72.7%) |

**完全达标模型** (8个):
1. examples/mnist ✅
2. examples/mnist_ff ✅
3. examples/mnist_rnn ✅
4. examples/siamese ✅
5. Person_reID_baseline_pytorch/densenet121 ✅
6. Person_reID_baseline_pytorch/hrnet18 ✅
7. Person_reID_baseline_pytorch/pcb ✅
8. pytorch_resnet_cifar10/resnet20 ✅

**未达标模型** (3个):
- VulBERTa/mlp: 两种模式全部缺失（0/5每参数）
- bug-localization: 两种模式全部缺失（0/5每参数）
- MRT-OAST: 仅并行模式缺失（3/5每参数）

---

## Phase 6配置验证

### 配置有效性 ✅
Phase 6配置（`settings/phase6_vulberta_mlp_completion.json`）：
- 目标实验数: 40个
- 预计时间: 41.72小时
- 目标模型: VulBERTa/mlp

**与修复后计算完全一致** ✅

---

## 关键发现

### 1. 能耗数据缺失模式
- **总体**: 37%实验缺少能耗数据（虽然有性能数据）
- **非并行模式**: 70%完整（203/288）
- **并行模式**: 56%完整（168/296）

**推测原因**:
1. 早期实验能耗监控不稳定
2. 部分实验perf/nvidia-smi权限问题
3. 能耗数据提取失败但训练继续

### 2. 修复对研究目标的意义
- **更严格验证**: 确保所有实验同时有训练、性能、能耗数据
- **符合研究目标**: 研究超参数对**能耗和性能**的影响
- **避免误导**: 防止缺失能耗数据的实验被计入有效实验

### 3. 后续建议
1. **数据补全**: 对缺失能耗数据的59个实验考虑重新运行
2. **监控加强**: 确保未来实验能耗监控稳定性
3. **验证优先**: 能耗数据应与性能数据同等重要

---

## 文件变更

### 修改文件
- `scripts/calculate_experiment_gap.py`
  - **Line 118-119**: 添加并行模式能耗检查
  - **Line 126-127**: 添加非并行模式能耗检查
  - **Line 133**: 更新验证逻辑（添加has_energy检查）

### 文档更新
- `docs/results_reports/V4_7_7_WORK_COMPLETION_SUMMARY.md` - 添加Bug 2说明
- `V4_7_7_UPDATE_NOTES.md` - 添加Bug 2说明
- `docs/results_reports/CALCULATE_GAP_ENERGY_VALIDATION_FIX.md` - 本报告（新增）

---

## 测试验证

### 验证步骤
```bash
# 运行修复后的脚本
python3 scripts/calculate_experiment_gap.py

# 检查输出
# 有效实验数: 371 ✅
# 实验缺口: 90个 ✅
# 达标情况: 17/90 (18.9%) ✅
```

### 验证结果
- ✅ 有效实验数准确统计（371个）
- ✅ 实验缺口准确计算（90个）
- ✅ 达标情况正确显示（17/90）
- ✅ Phase 6配置仍然有效（40实验，41.72h）

---

## 总结

### 修复要点
1. **发现**: 验证逻辑遗漏能耗数据检查
2. **影响**: 高估有效实验数，低估实验缺口
3. **修复**: 添加has_energy检查（CPU + GPU总能耗）
4. **结果**: 准确统计371个有效实验，90个实验缺口

### 经验教训
1. **完整性验证**: 所有研究目标要求的数据类型都应验证
2. **模式区分**: 并行/非并行模式字段前缀不同（fg_* vs 无前缀）
3. **文档重要性**: CLAUDE.md明确定义了研究目标和数据要求

### 下一步行动
- ✅ 修复完成，脚本已更新
- ✅ 文档已更新
- ⏳ 等待Phase 6执行

---

**报告生成**: 2025-12-15
**修复状态**: ✅ 已完成并验证
**影响评估**: 中等（提高数据质量要求，更准确反映实验完成度）
